generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS - Sprint 4 Type Safety
// ============================================

// User Roles: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
enum UserRole {
  ADMIN // ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö
  MANAGER // ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ users ‡πÉ‡∏ô‡∏ó‡∏µ‡∏°)
  CLIENT // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
  VIEWER // ‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (read-only)
}

// Campaign Status: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤
enum CampaignStatus {
  ACTIVE // ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
  PAUSED // ‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
  DELETED // ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß
  PENDING // ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
  COMPLETED // ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß
}

// Ad Platform: ‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
enum AdPlatform {
  GOOGLE_ADS
  FACEBOOK
  TIKTOK
  LINE_ADS
  GOOGLE_ANALYTICS
}

// Notification Channel: ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
enum NotificationChannel {
  IN_APP // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ
  EMAIL // ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•
  LINE // ‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô LINE
  SMS // ‡∏™‡πà‡∏á SMS
}

// Alert Severity: ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏Ç‡∏≠‡∏á Alert
enum AlertSeverity {
  INFO // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
  WARNING // ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
  CRITICAL // ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï
}

// Sync Status: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£ Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
enum SyncStatus {
  PENDING // ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
  STARTED // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß
  IN_PROGRESS // ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
  SUCCESS // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
  COMPLETED // ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
  FAILED // ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
}

// Alert Status: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á Alert
enum AlertStatus {
  OPEN // ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
  ACKNOWLEDGED // ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡πâ‡∏ß
  RESOLVED // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß
}

// Sync Type: ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£ Sync
enum SyncType {
  INITIAL // ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
  SCHEDULED // ‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î
  MANUAL // Manual
}

// Alert Rule Type: ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏é‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
enum AlertRuleType {
  PRESET // Preset ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
  CUSTOM // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á
}

// ============================================
// Core Models
// ============================================

model Tenant {
  id        String   @id @default(cuid())
  name      String
  settings  Json? // Changed from String to Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Existing Relations
  apiConnections          APIConnection[]
  campaigns               Campaign[]
  facebookAdsAccounts     FacebookAdsAccount[]     @relation("FacebookAdsAccounts")
  googleAdsAccounts       GoogleAdsAccount[]       @relation("GoogleAdsAccounts")
  googleAnalyticsAccounts GoogleAnalyticsAccount[] @relation("GoogleAnalyticsAccounts")
  lineAdsAccounts         LineAdsAccount[]         @relation("LineAdsAccounts")
  tiktokAdsAccounts       TikTokAdsAccount[]       @relation("TikTokAdsAccounts")
  users                   User[]

  // Alert System
  alertRules AlertRule[]
  alerts     Alert[]

  // Sync System
  syncLogs SyncLog[]

  // Sprint 4: New Relations
  notifications  Notification[]
  platformTokens PlatformToken[]
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  role      UserRole @default(CLIENT) // Changed from String to UserRole
  isActive  Boolean  @default(true)
  tenantId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üîê Security Enhancement (Sprint 4)
  lastLoginAt       DateTime? // ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà login
  lastLoginIp       String? // IP Address ‡∏ó‡∏µ‡πà login
  failedLoginCount  Int       @default(0) // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á login ‡∏ú‡∏¥‡∏î
  lockedUntil       DateTime? // ‡∏•‡πá‡∏≠‡∏Ñ account ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á
  passwordChangedAt DateTime? // ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™
  twoFactorEnabled  Boolean   @default(false)

  // üîî Notification & Preferences
  notificationPreferences Json? // { "email": true, "inApp": true }
  timezone                String? @default("Asia/Bangkok")
  language                String? @default("th")

  // Relations
  sessions      Session[]
  tenant        Tenant         @relation(fields: [tenantId], references: [id])
  notifications Notification[]

  @@index([role])
  @@index([isActive])
  @@index([tenantId, isActive])
  @@index([email])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  ipAddress    String? // Sprint 4: Security
  userAgent    String? // Sprint 4: Security
  user         User     @relation(fields: [userId], references: [id])
}

model Campaign {
  id                   String         @id @default(cuid())
  name                 String
  platform             AdPlatform // Changed from String to AdPlatform
  status               CampaignStatus // Changed from String to CampaignStatus
  budget               Float?
  startDate            DateTime?
  endDate              DateTime?
  externalId           String?
  googleAdsAccountId   String?
  facebookAdsAccountId String?
  tiktokAdsAccountId   String?
  lineAdsAccountId     String?
  lastSyncedAt         DateTime?
  syncStatus           SyncStatus?    @default(PENDING) // Changed from String to SyncStatus
  tenantId             String
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  // Relations
  lineAdsAccount     LineAdsAccount?     @relation(fields: [lineAdsAccountId], references: [id])
  tiktokAdsAccount   TikTokAdsAccount?   @relation(fields: [tiktokAdsAccountId], references: [id])
  facebookAdsAccount FacebookAdsAccount? @relation(fields: [facebookAdsAccountId], references: [id])
  googleAdsAccount   GoogleAdsAccount?   @relation(fields: [googleAdsAccountId], references: [id])
  tenant             Tenant              @relation(fields: [tenantId], references: [id])
  metrics            Metric[]
  alerts             Alert[]

  @@unique([tenantId, externalId])
  @@index([googleAdsAccountId])
  @@index([platform])
  @@index([status])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
}

model Metric {
  id          String   @id @default(cuid())
  campaignId  String
  date        DateTime
  impressions Int
  clicks      Int
  spend       Float
  conversions Int
  revenue     Float
  ctr         Float    @default(0)
  cpc         Float    @default(0)
  cpm         Float    @default(0)
  roas        Float    @default(0)
  isMockData  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  campaign    Campaign @relation(fields: [campaignId], references: [id])

  @@unique([campaignId, date])
  @@index([date])
  @@index([campaignId, date])
}

// ============================================
// Platform Account Models
// ============================================

model GoogleAdsAccount {
  id             String     @id @default(cuid())
  tenantId       String
  customerId     String
  accountName    String?
  status         String     @default("ENABLED")
  accessToken    String
  refreshToken   String
  tokenExpiresAt DateTime?
  lastSyncAt     DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  campaigns      Campaign[]
  tenant         Tenant     @relation("GoogleAdsAccounts", fields: [tenantId], references: [id])

  @@unique([tenantId, customerId])
  @@index([status])
}

model GoogleAnalyticsAccount {
  id             String    @id @default(cuid())
  tenantId       String
  propertyId     String
  propertyName   String?
  accessToken    String
  refreshToken   String
  tokenExpiresAt DateTime?
  status         String    @default("ACTIVE")
  lastSyncAt     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  tenant         Tenant    @relation("GoogleAnalyticsAccounts", fields: [tenantId], references: [id])

  @@unique([tenantId, propertyId])
}

model FacebookAdsAccount {
  id             String     @id @default(cuid())
  tenantId       String
  accountId      String
  accountName    String?
  accessToken    String
  tokenExpiresAt DateTime?
  status         String     @default("ACTIVE")
  lastSyncAt     DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  campaigns      Campaign[]
  tenant         Tenant     @relation("FacebookAdsAccounts", fields: [tenantId], references: [id])

  @@unique([tenantId, accountId])
  @@index([status])
}

model TikTokAdsAccount {
  id             String     @id @default(cuid())
  tenantId       String
  advertiserId   String
  accountName    String?
  accessToken    String
  refreshToken   String?
  tokenExpiresAt DateTime?
  status         String     @default("ACTIVE")
  lastSyncAt     DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  campaigns      Campaign[]
  tenant         Tenant     @relation("TikTokAdsAccounts", fields: [tenantId], references: [id])

  @@unique([tenantId, advertiserId])
}

model LineAdsAccount {
  id             String     @id @default(cuid())
  tenantId       String
  channelId      String
  channelName    String?
  accessToken    String
  tokenExpiresAt DateTime?
  status         String     @default("ACTIVE")
  lastSyncAt     DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  campaigns      Campaign[]
  tenant         Tenant     @relation("LineAdsAccounts", fields: [tenantId], references: [id])

  @@unique([tenantId, channelId])
}

model APIConnection {
  id          String    @id @default(cuid())
  tenantId    String
  platform    String
  credentials String
  isActive    Boolean   @default(true)
  lastSyncAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  tenant      Tenant    @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, platform])
}

// ============================================
// Logging & Analytics Models
// ============================================

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  resource  String
  details   String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model WebAnalyticsDaily {
  id                 String   @id @default(cuid())
  tenantId           String
  propertyId         String
  date               DateTime
  activeUsers        Int      @default(0)
  newUsers           Int      @default(0)
  sessions           Int      @default(0)
  screenPageViews    Int      @default(0)
  engagementRate     Float    @default(0)
  bounceRate         Float    @default(0)
  avgSessionDuration Float    @default(0)
  isMockData         Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([tenantId, propertyId, date])
  @@index([tenantId])
  @@index([date])
  @@index([propertyId])
}

// ============================================
// Alert System Models
// ============================================

model AlertRule {
  id          String        @id @default(cuid())
  tenantId    String
  name        String
  type        AlertRuleType @default(PRESET) // Changed from String to AlertRuleType
  metric      String
  operator    String
  threshold   Float
  severity    AlertSeverity @default(WARNING) // Changed from String to AlertSeverity
  isActive    Boolean       @default(true)
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  tenant Tenant  @relation(fields: [tenantId], references: [id])
  alerts Alert[]

  @@index([tenantId])
  @@index([isActive])
}

model Alert {
  id         String        @id @default(cuid())
  tenantId   String
  ruleId     String?
  campaignId String?
  type       String
  severity   AlertSeverity // Changed from String to AlertSeverity
  title      String
  message    String
  metadata   Json? // Changed from String to Json
  status     AlertStatus   @default(OPEN) // Changed from String to AlertStatus
  createdAt  DateTime      @default(now())
  resolvedAt DateTime?

  tenant        Tenant         @relation(fields: [tenantId], references: [id])
  rule          AlertRule?     @relation(fields: [ruleId], references: [id])
  campaign      Campaign?      @relation(fields: [campaignId], references: [id])
  notifications Notification[]

  @@index([tenantId])
  @@index([status])
  @@index([severity])
  @@index([createdAt])
  @@index([tenantId, status, createdAt])
}

// ============================================
// Notification System - Sprint 4
// ============================================

model Notification {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  // Content
  type    String // ALERT, REPORT_READY, SYNC_COMPLETE, SYSTEM
  title   String
  message String @db.Text

  // Channel & Delivery
  channel  NotificationChannel @default(IN_APP)
  priority String              @default("NORMAL") // LOW, NORMAL, HIGH, URGENT

  // Metadata for Frontend Actions (JSONB)
  metadata Json? @db.JsonB
  // Example: { "actionUrl": "/campaigns/123", "actionText": "View", "icon": "alert" }

  // Status
  isRead      Boolean   @default(false)
  readAt      DateTime?
  isDismissed Boolean   @default(false)

  // References
  alertId    String?
  campaignId String?

  // Timestamps
  scheduledAt DateTime?
  sentAt      DateTime?
  createdAt   DateTime  @default(now())
  expiresAt   DateTime?

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  alert  Alert? @relation(fields: [alertId], references: [id], onDelete: SetNull)

  @@index([userId, isRead])
  @@index([tenantId])
  @@index([createdAt])
  @@index([type])
  @@index([userId, createdAt])
}

// ============================================
// Unified Token Management - Sprint 4
// ============================================

model PlatformToken {
  id        String     @id @default(cuid())
  tenantId  String
  platform  AdPlatform
  accountId String

  // Token Storage
  accessToken  String  @db.Text
  refreshToken String? @db.Text
  tokenType    String? @default("Bearer")
  tokenScope   String?

  // Lifecycle
  expiresAt   DateTime?
  refreshedAt DateTime?
  lastUsedAt  DateTime?

  // Health
  isValid         Boolean @default(true)
  errorMessage    String?
  refreshAttempts Int     @default(0)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, platform, accountId])
  @@index([platform])
  @@index([isValid])
}

// ============================================
// Sync Log Model
// ============================================

model SyncLog {
  id           String     @id @default(cuid())
  tenantId     String
  platform     AdPlatform // Changed from String to AdPlatform
  accountId    String?
  syncType     SyncType? // Changed from String to SyncType
  status       SyncStatus @default(PENDING) // Changed from String to SyncStatus
  startedAt    DateTime   @default(now())
  completedAt  DateTime?
  errorMessage String?
  recordsCount Int?
  recordsSync  Int        @default(0)
  createdAt    DateTime   @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([platform])
  @@index([status])
  @@index([createdAt])
  @@index([accountId])
}
