# Database Wiki: RGA AI Dashboard
> **Target Architecture for Sprint 4** | Last Updated: 2026-01-10

---

## 1. System Overview & Tech Stack ðŸ› ï¸

### Technology Stack
| Component | Technology | Description |
|-----------|------------|-------------|
| **Database** | PostgreSQL | Relational database with JSONB support |
| **ORM** | Prisma | Type-safe database client |
| **Platform** | Supabase | Managed PostgreSQL + Auth + Real-time |
| **Backend** | NestJS | Node.js framework with TypeScript |

### Sprint 4 Scope Summary
à¸ˆà¸²à¸à¹€à¸­à¸à¸ªà¸²à¸£à¹à¸œà¸™à¸‡à¸²à¸™ Sprint 4 à¸¡à¸¸à¹ˆà¸‡à¹€à¸™à¹‰à¸™:
- **Dashboard Filter Enhancement** - à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡ UI (Filter, Date range, Download)
- **Performance Optimization** - Caching à¹à¸¥à¸° API rate handling
- **UAT & Feedback** - à¸—à¸”à¸ªà¸­à¸šà¸à¸±à¸šà¸¥à¸¹à¸à¸„à¹‰à¸²à¸ˆà¸£à¸´à¸‡à¹à¸¥à¸°à¸›à¸£à¸±à¸šà¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡ data model
- **Notification System** - à¸£à¸°à¸šà¸šà¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¸—à¸µà¹ˆà¸„à¸£à¸šà¸–à¹‰à¸§à¸™
- **Multi-platform Ads** - à¸£à¸­à¸‡à¸£à¸±à¸š Google, Facebook, TikTok, LINE Ads

---

## 2. Schema Standards (Design Rules) ðŸ“

### 2.1 Enums Strategy

> [!IMPORTANT]
> Sprint 4 à¸•à¹‰à¸­à¸‡à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ String fields à¹€à¸›à¹‡à¸™ Prisma Enum à¹€à¸žà¸·à¹ˆà¸­ Type-safety à¹à¸¥à¸° Data integrity

#### Required Enum Conversions

```prisma
// User Role Enum
enum UserRole {
  ADMIN
  MANAGER
  CLIENT
  VIEWER
}

// Campaign Status Enum
enum CampaignStatus {
  ACTIVE
  PAUSED
  DELETED
  PENDING
  COMPLETED
}

// Ad Platform Enum
enum AdPlatform {
  GOOGLE_ADS
  FACEBOOK
  TIKTOK
  LINE_ADS
  GOOGLE_ANALYTICS
}

// Notification Channel Enum
enum NotificationChannel {
  IN_APP
  EMAIL
  LINE
  SMS
}

// Alert Severity Enum
enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}

// Sync Status Enum
enum SyncStatus {
  PENDING
  STARTED
  IN_PROGRESS
  SUCCESS
  COMPLETED
  FAILED
}
```

#### Fields to Convert

| Model | Field | Current Type | Target Enum |
|-------|-------|--------------|-------------|
| `User` | `role` | `String` | `UserRole` |
| `Campaign` | `status` | `String` | `CampaignStatus` |
| `Campaign` | `platform` | `String` | `AdPlatform` |
| `SyncLog` | `platform` | `String` | `AdPlatform` |
| `SyncLog` | `status` | `String` | `SyncStatus` |
| `Alert` | `severity` | `String` | `AlertSeverity` |
| `AlertRule` | `severity` | `String` | `AlertSeverity` |

---

### 2.2 Naming Conventions

| Element | Convention | Example |
|---------|------------|---------|
| **Table/Model** | PascalCase | `User`, `Campaign`, `AlertRule` |
| **Field** | camelCase | `createdAt`, `lastSyncAt`, `tenantId` |
| **Foreign Key** | camelCase + "Id" | `userId`, `campaignId`, `tenantId` |
| **Enum** | PascalCase | `UserRole`, `CampaignStatus` |
| **Enum Values** | UPPER_SNAKE_CASE | `IN_PROGRESS`, `GOOGLE_ADS` |
| **Index** | Auto-generated by Prisma | `@@index([field])` |

---

## 3. Target Data Structure ðŸŽ¯

### 3.1 Users & Security

#### Current Fields (Existing)
```prisma
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  role      String   @default("CLIENT")
  isActive  Boolean  @default(true)
  tenantId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

#### Required New Fields for Sprint 4

```prisma
model User {
  // ... existing fields ...
  
  // ðŸ” Security Enhancement (à¸•à¸²à¸¡ Requirement)
  lastLoginAt       DateTime?         // à¸„à¸£à¸±à¹‰à¸‡à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢à¸—à¸µà¹ˆ login
  lastLoginIp       String?           // IP Address à¸‚à¸­à¸‡à¸à¸²à¸£ login
  failedLoginCount  Int       @default(0)  // à¸ˆà¸³à¸™à¸§à¸™à¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆ login à¸œà¸´à¸”
  lockedUntil       DateTime?         // à¸¥à¹‡à¸­à¸„ account à¸ˆà¸™à¸à¸§à¹ˆà¸²
  passwordChangedAt DateTime?         // à¸„à¸£à¸±à¹‰à¸‡à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢à¸—à¸µà¹ˆà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸£à¸«à¸±à¸ª
  twoFactorEnabled  Boolean   @default(false)
  
  // ðŸ”” Notification Preferences
  notificationPreferences Json?        // { "email": true, "inApp": true, "line": false }
  
  // ðŸ“± UI Preferences
  timezone          String?   @default("Asia/Bangkok")
  language          String?   @default("th")
  
  // Relations
  notifications     Notification[]
}
```

> [!NOTE]
> **Requirement Reference:** "à¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢ & à¸à¸²à¸£à¹€à¸à¹‡à¸š Log: à¹€à¸žà¸£à¸²à¸°à¹€à¸›à¹‡à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸¡à¸µà¸„à¹ˆà¸²à¹à¸¥à¸°à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§" (Line 43)

---

### 3.2 Notification System

#### New Table: `Notification`

```prisma
// ============================================
// Notification System - Sprint 4
// ============================================

model Notification {
  id          String               @id @default(cuid())
  tenantId    String
  userId      String
  
  // Content
  type        String               // ALERT, REPORT_READY, SYNC_COMPLETE, SYSTEM, CAMPAIGN_UPDATE
  title       String               // "Campaign Budget Alert"
  message     String               // "Campaign X has exceeded 90% budget"
  
  // Channel & Delivery
  channel     NotificationChannel  @default(IN_APP)
  priority    String               @default("NORMAL")  // LOW, NORMAL, HIGH, URGENT
  
  // ðŸ“¦ Metadata for Frontend Actions (JSONB)
  metadata    Json?                // { "actionUrl": "/campaigns/123", "actionText": "View Campaign", "icon": "alert-circle" }
  
  // Status
  isRead      Boolean              @default(false)
  readAt      DateTime?
  isDismissed Boolean              @default(false)
  
  // Reference
  alertId     String?              // Link to Alert if notification from alert
  campaignId  String?              // Related campaign
  
  // Timestamps
  scheduledAt DateTime?            // For scheduled notifications
  sentAt      DateTime?
  createdAt   DateTime             @default(now())
  expiresAt   DateTime?            // Auto-dismiss after this time
  
  // Relations
  tenant      Tenant               @relation(fields: [tenantId], references: [id])
  user        User                 @relation(fields: [userId], references: [id])
  alert       Alert?               @relation(fields: [alertId], references: [id])
  
  @@index([userId, isRead])
  @@index([tenantId])
  @@index([createdAt])
  @@index([type])
}
```

#### Metadata JSONB Structure Examples

```json
// Alert Notification
{
  "actionUrl": "/dashboard/alerts",
  "actionText": "à¸”à¸¹à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”",
  "icon": "alert-triangle",
  "alertType": "LOW_ROAS",
  "campaignName": "Summer Sale 2026"
}

// Report Ready Notification
{
  "actionUrl": "/reports/download/abc123",
  "actionText": "à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¸£à¸²à¸¢à¸‡à¸²à¸™",
  "icon": "file-text",
  "reportType": "MONTHLY_PERFORMANCE",
  "format": "PDF"
}

// Sync Complete Notification
{
  "actionUrl": "/settings/integrations",
  "actionText": "à¸”à¸¹à¸œà¸¥à¸à¸²à¸£ Sync",
  "icon": "refresh-cw",
  "platform": "GOOGLE_ADS",
  "recordsSynced": 150
}
```

> [!TIP]
> **Requirement Reference:** "à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™ (Alert/Notification): à¸–à¹‰à¸² metric à¹ƒà¸”à¹† à¹€à¸à¸´à¸™à¸«à¸£à¸·à¸­à¸•à¹ˆà¸³à¸à¸§à¹ˆà¸²à¸„à¹ˆà¸²à¸—à¸µà¹ˆà¸•à¸±à¹‰à¸‡à¹„à¸§à¹‰" (Line 22)

---

### 3.3 Ads Integration Token Storage

#### Current Structure (Existing)
à¹à¸•à¹ˆà¸¥à¸° Platform à¸¡à¸µ Model à¹à¸¢à¸:
- `GoogleAdsAccount` âœ…
- `FacebookAdsAccount` âœ…
- `TikTokAdsAccount` âœ…
- `LineAdsAccount` âœ…

#### Enhanced Token Management Table

```prisma
// ============================================
// Unified Token Management - Sprint 4
// ============================================

model PlatformToken {
  id              String      @id @default(cuid())
  tenantId        String
  platform        AdPlatform  // GOOGLE_ADS, FACEBOOK, TIKTOK, LINE_ADS
  accountId       String      // Platform-specific account ID
  
  // ðŸ” Token Storage (Encrypted)
  accessToken     String      @db.Text
  refreshToken    String?     @db.Text
  tokenType       String?     @default("Bearer")
  tokenScope      String?     // OAuth scopes granted
  
  // Token Lifecycle
  expiresAt       DateTime?
  refreshedAt     DateTime?
  lastUsedAt      DateTime?
  
  // Token Health
  isValid         Boolean     @default(true)
  errorMessage    String?
  refreshAttempts Int         @default(0)
  
  // Audit
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  createdBy       String?     // User who connected
  
  tenant          Tenant      @relation(fields: [tenantId], references: [id])
  
  @@unique([tenantId, platform, accountId])
  @@index([platform])
  @@index([isValid])
}
```

#### Platform-Specific Token Requirements

| Platform | Required Fields | Optional Fields | Refresh Strategy |
|----------|----------------|-----------------|------------------|
| **Google Ads** | `accessToken`, `refreshToken`, `customerId` | `developerToken` | Auto-refresh via refresh_token |
| **Facebook** | `accessToken`, `accountId` | `pageAccessToken` | Long-lived token (60 days) |
| **TikTok** | `accessToken`, `refreshToken`, `advertiserId` | - | Refresh every 24 hours |
| **LINE Ads** | `accessToken`, `channelId` | `channelSecret` | Manual reconnect |

---

## 4. Migration Notes ðŸ“‹

### 4.1 Gap Analysis: Existing vs Required

#### âœ… Already Exists in Current Schema

| Feature | Model | Status |
|---------|-------|--------|
| Multi-tenant | `Tenant`, `tenantId` FK | âœ… Complete |
| User Authentication | `User`, `Session` | âœ… Complete |
| Campaign Tracking | `Campaign`, `Metric` | âœ… Complete |
| Google Ads | `GoogleAdsAccount` | âœ… Complete |
| Facebook Ads | `FacebookAdsAccount` | âœ… Complete |
| TikTok Ads | `TikTokAdsAccount` | âœ… Complete |
| LINE Ads | `LineAdsAccount` | âœ… Complete |
| Alert Rules | `AlertRule` | âœ… Complete |
| Alert Instances | `Alert` | âœ… Complete |
| Sync Logging | `SyncLog` | âœ… Complete |
| Audit Logging | `AuditLog` | âœ… Complete |
| Web Analytics | `WebAnalyticsDaily` | âœ… Complete |

#### ðŸ”¨ Must Create for Sprint 4

| Feature | Model/Change | Priority | Description |
|---------|--------------|----------|-------------|
| **Notification System** | `Notification` (NEW) | ðŸ”´ High | à¸•à¸²à¸£à¸²à¸‡ Notification à¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™ user |
| **Security Fields** | `User` (MODIFY) | ðŸ”´ High | à¹€à¸žà¸´à¹ˆà¸¡ `lastLoginAt`, `lastLoginIp`, etc. |
| **Enums** | All Models | ðŸŸ¡ Medium | à¹à¸›à¸¥à¸‡ String â†’ Enum |
| **Token Management** | `PlatformToken` (NEW) | ðŸŸ¡ Medium | Unified token storage |
| **Notification Preferences** | `User` (MODIFY) | ðŸŸ¢ Low | à¹€à¸žà¸´à¹ˆà¸¡ `notificationPreferences` JSON |
| **Alert-Notification Link** | `Alert` (MODIFY) | ðŸŸ¢ Low | à¹€à¸žà¸´à¹ˆà¸¡ relation to `Notification` |

---

### 4.2 Migration Checklist

```markdown
- [ ] Create Enums (UserRole, CampaignStatus, AdPlatform, etc.)
- [ ] Migrate User.role String â†’ UserRole Enum
- [ ] Migrate Campaign.status String â†’ CampaignStatus Enum
- [ ] Add User security fields (lastLoginAt, lastLoginIp, etc.)
- [ ] Create Notification table
- [ ] Add Notification relation to User
- [ ] Add Notification relation to Alert
- [ ] Create PlatformToken table (optional: consolidate tokens)
- [ ] Update AlertRule.severity/Alert.severity â†’ AlertSeverity Enum
- [ ] Add Tenant relation to Notification
```

---

### 4.3 Schema Version History

| Version | Date | Sprint | Changes |
|---------|------|--------|---------|
| v1.0 | 2025-11 | Sprint 1 | Initial: User, Tenant, Campaign, Metric |
| v1.1 | 2025-11 | Sprint 2 | Added: GoogleAdsAccount, FacebookAdsAccount |
| v1.2 | 2025-12 | Sprint 3 | Added: Alert, AlertRule, SyncLog, TikTok/LINE |
| **v2.0** | **2026-01** | **Sprint 4** | **Target: Notification, Enums, Security** |

---

## Appendix: ERD Overview

```mermaid
erDiagram
    Tenant ||--o{ User : has
    Tenant ||--o{ Campaign : owns
    Tenant ||--o{ Notification : receives
    Tenant ||--o{ AlertRule : defines
    
    User ||--o{ Session : has
    User ||--o{ Notification : receives
    
    Campaign ||--o{ Metric : tracks
    Campaign ||--o{ Alert : triggers
    
    AlertRule ||--o{ Alert : generates
    Alert ||--o{ Notification : creates
    
    Tenant ||--o{ GoogleAdsAccount : connects
    Tenant ||--o{ FacebookAdsAccount : connects
    Tenant ||--o{ TikTokAdsAccount : connects
    Tenant ||--o{ LineAdsAccount : connects
```

---

> **Document Owner:** Lead Data Architect  
> **Review Status:** Draft for Sprint 4 Planning
